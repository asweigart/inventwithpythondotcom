<head>
<title>Source Code Makeover: Demon Kingdom, Part 1</title>
<meta name="tags" content="" />
<meta name="date" content="2013-06-12 12:00" />
<meta name="summary" content="<p>In this blog post, I’m taking a game off of <a href=&quot;http://pygame.org&quot;>Pygame.org</a> and going through it to make it more readable and extend its functionality.</p>" />
</head>
<body>


			<p>In this blog post, I’m taking a game off of <a href="http://pygame.org">Pygame.org</a> and going through it to make it more readable and extend its functionality. This is an intermediate level tutorial and assumes some familiarity with Python. This can be pretty helpful if you know programming basics but want to know, “How can I write better code?" (<strong>And because someone always brings it up, I have this disclaimer:</strong> Of course, these changes are my own subjective idea of "better" and not necessarily changes that another developer would make.)</p>
<p><a href="/blog/images/demon-kingdom_screenshot.jpg?27f655"><img src="/blog/images/demon-kingdom_screenshot.jpg?27f655" width="300" /></a></p>
<p><a href="http://www.pygame.org/project-Demon+Kingdom-2403-.html">Demon Kingdom</a> by <a href="http://sourceforge.net/users/logi540">Logi540</a> is a defense game where monsters walk from the left side of the screen. The player needs to attack them by clicking on them, and can pick up gems to use for spells. If any monster reaches the right side of the screen, the player loses. <a href="/DemonKingdom.zip?27f655">Download source code.</a></p>
<p>The main theme of my changes is:</p>
<ul>
<li><strong>Removing duplicate code.</strong> Duplicate code is bad because if you have to change it (to add features or fix bugs) you may forget to change it in every duplicated place.</li>
<li><strong>Remove magic numbers.</strong> Magic numbers are hard-coded integer values which are bad because they don't describe what they represent. A better alternative is to use a constant instead (these are the ALL-CAPS variables).</li>
<li><strong>Put sequential variables in lists and use loops.</strong> Instead of having variables named like <code>spam1</code>, <code>spam2</code>, <code>spam3</code>, and so on, it's better to have a single list variable, and have a loop run code on each item in the list. This usually leads to a decrease in duplicate code.</li>
<li><strong>Get rid of unneeded variables.</strong> Removing code reaps tons of benefits: there's less code a programmer has to read and understand, less code that a programmer has to look through when debugging, and less code (usually) means less bugs and "moving parts" that could break.</li>
</ul>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/9d1cb8c98d3fcfca1ca9ee1777553694ec5fc341#DemonKingdom">Here's the inital check in of all the files.</a> The file I'll be modifying is named <code>demonkingdom_makeover.py</code>. This program requires <a href="http://pygame.org">Pygame</a> to be installed to run. I recommend <a href="http://sourceforge.net/projects/demonkingdom/files/latest/download">downloading the game</a>, playing it a couple times, and looking through the source code before continuing with this article. For each section, open up the diff link to see what the exact changes I made were.</p>
<p><span id="more-977"></span></p>
<h3>Remove Dependency on easygui</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/4b29eecadfef8cadcf4ea8fadb34895d2bdda76a#DemonKingdom/demonkingdom_makeover.py">Removed easygui requirement and changed image & sound file paths</a></p>
<p>The first change I'm going to make is to get rid of the use of the <code><a href="http://easygui.sourceforge.net/">easygui</a></code> module. The game uses this just to display a message box that displays some credits. Without this call to <code>easygui.msgbox()</code>, the fewer additional modules the user will need to run this game (and the more likely people will play it).</p>
<p>I've also put all the image files under their own folder named "images", so I'll have to change the lines of code that load these to include the new path.</p>
<h3>Add Spaces for Readability</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/442cfc141c38e09d8e46840ad612ea591bb381a6#DemonKingdom/demonkingdom_makeover.py">Renamed SpellIcon class. Added spaces after +, -, and * operators.</a></p>
<p>As a general cleanup of the code to make it more readable, I prefer a single space after commas in the source code so that it is not bunched together. Using the find-and-replace feature in my text editor, I replace all commas with a comma and space. Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/fd5477e1f031577eb464dd4017fafb2e53427d39#DemonKingdom/demonkingdom_makeover.py">Added spaces after all the commas</a></p>
<p>I do some more cleanup by adding spaces around the <code>+</code>, <code>-</code>, and <code>*</code> operators in the source code, as well as capitalizing the <code>spellIcon</code> class. It is a common convention in programming to have class names begin with a capital letter.</p>
<h3>Improve the Background Class</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/42a6bf0e080a62b26455fa7cfe44ca8d5bb148f2#DemonKingdom/demonkingdom_makeover.py">Improved the Background class.</a></p>
<p>Next, I make some improvements to the <code>Background</code> class. This class loads and stores all the background images as <code>pygame.Surface</code> objects. Previously the single <code>Background</code> object would be passed an image object with its <code>changeBackground()</code> method. In order to put all the background-loading code in the same place, I had this take place in the constructor method of the class.</p>
<p>The <code>Background</code> constructor is now passed a list of background images, which is loads and stores in its <code>imageList</code> member. A single list variable is always preferable to variables like <code>back2</code>, <code>back3</code>, <code>back4</code>, and so on. Now when <code>changeBackground()</code> is called, we simply pass it the index of the image it should be changed to.</p>
<p>Also, the <code>rect</code> member is updated based on the image when <code>changeBackground()</code> is called. Previously the code assumed that all the background images were the same size and used the rect from the first background for all the backgrounds.</p>
<h3>Replace Magic Numbers with Constants</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/81cfe27ecd0393dd5ae78082a1ca7d70e8dbd82d#DemonKingdom/demonkingdom_makeover.py">Improved Sidebar class. Created numGems global. Added size constants. Renamed Logo class.</a></p>
<p>Next I want to get rid of the <a href="https://en.wikipedia.org/wiki/Magic_number_(programming)#Unnamed_numerical_constants">magic numbers</a> used in the source code. These a numbers that appear in the source code that do not have explanations, which can make it hard to figure out what they are used for. Instead we will replace them with constant variables with descriptive names. These include the <code>MAP_WIDTH</code>, <code>MAP_HEIGHT</code>, <code>SIDEBAR_HEIGHT</code>, <code>WINDOW_WIDTH</code>, and <code>WINDOW_HEIGHT</code> variables.</p>
<p>I also rename some variables to be more descriptive (such as changing <code>gems</code> to <code>numGemsCache</code>) and created a new <code>numGems</code> global variable. Normally I don't advocate using global variables, but in this case the code had placed the <code>gems</code> member in the <code>Sidebar</code> class. This is odd because the <code>Sidebar</code> class should deal with the user interface and displaying game info, not tracking the state of the player. Also, only one <code>Sidebar</code> object is created, effectively making it a global variable anyway. This change also lets me get rid of the <code>addGems()</code> method from the <code>Sidebar</code> class.</p>
<p>I replace several calls to the <code>SpellIcon</code> constructor with a loop (lines 34 to 41 of the original file), and capitalize the name of the <code>Logo</code> class.</p>
<h3>Get Rid of the Unneeded load() Method</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/cd4e576fb0cb259adad5cc9175dd743d0c80cede#DemonKingdom/demonkingdom_makeover.py">Got rid of first_frame member. Renamed MySprite class. Renamed spellEffect class. Got rid of the load() methods in the AnimatedSprite classes.</a></p>
<p>Originally each monster is an object of the <code>Monster</code> class, which is a child class of the <code>MySprite</code> class, which itself is a child of Pygame's <code>pygame.sprite.Sprite</code> class. This is an odd choice to make because a monster is not a sprite image, but rather several things that can <em>include</em> sprite images. However, I've found it difficult to break out this inheritance structure, so instead I just renamed <code>MySprite</code> to the more descriptive name <code>AnimatedSprite</code>.</p>
<p>I renamed the color-related variables (<code>white</code>, <code>lightGrey</code>, etc.) to capitalized names to show that they are constants.</p>
<p>Since the <code>load()</code> method in the <code>AnimatedSprite</code> class was always called directly after the constructor, I saw no reason why there should be a separate <code>load()</code> method and moved its code into the constructor.</p>
<p>Also, the <code>first_frame</code> member variable never has a value other than <code>0</code>, so I got rid of it and simply used <code>0</code> in its place. (Though it could be argued that that is a magic number and should be replaced with a constant.)</p>
<p>I capitalized the name of the <code>SpellEffect</code> class.</p>
<h3>Make __str__() More Debug-Friendly</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/9464d1c2055396a64711d5325658bd0354e29fc4#DemonKingdom/demonkingdom_makeover.py">Added labels to the __str__() method of AnimatedSprite.</a></p>
<p>Next, the <code>__str__()</code> method of a class is what is called when a string value representation of the object is needed. This is useful to print out debugging information about an object, but the <code>AnimatedSprite</code> class's <code>__str__()</code> method only printed out values with labeling what they are. The developer would have to look back at the source code to find what each number stood for. I've added labels to these values.</p>
<h3>Add Spacing to Make MONSTER_STATS More Readable</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/684fca16545fc9a76f8b61a254ac37b567d005d8#DemonKingdom/demonkingdom_makeover.py">Improved readability of the monster stats, renamed stats constant.</a></p>
<p>The <code>stats</code> global variable holds all the details about the image, size, life, and speed attributes of each type of monster. I renamed this variable to <code>MONSTER_STATS</code> (to denote it as a constant) and also added some spacing and newlines to make it easier to read in the source code.</p>
<h3>Change Lists to Tuples, Make Monster Constructor Call More Compact</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/223321d7e839b950915deb4e9a173590decb6a81#DemonKingdom/demonkingdom_makeover.py">Some variable renames, switch lists to tuples in MONSTER_STATS, and simplified Monster ctor calls.</a></p>
<p>Next I renamed the <code>rect</code> member with the more descriptive <code>frame_rect</code> name (it is the rect object for the frame of the monster's image. I replaced the lists in the <code>MONSTER_STATS</code> global with tuples since these values do not change. A tuple is immutable; and using a tuple conveys to other programmers that these values never change when the program runs.</p>
<p>I also call the <code>Monster</code> constructor using an asterisk with <code>MONSTER_STATS[type]["image"]</code>. The asterisk passes all of the items in the <code>MONSTER_STATS[type]["image"]</code> tuple as individual arguments to the <code>Monster</code> constructor. This is much more compact than calling <code>Monster(screen, MONSTER_STATS[type]["image"][0], MONSTER_STATS[type]["image"][1], MONSTER_STATS[type]["image"][2], MONSTER_STATS[type]["image"][3])</code>.</p>
<h3>Don't Use Python's Existing Names, Don't Use Sequential Variable Names</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/ca57e193d95b50100691ca9e445712c39e96b81b#DemonKingdom/demonkingdom_makeover.py">Put variables into lists.</a></p>
<p>The use of <code>time</code> as a name used in different parts of the source code is a poor choice because there is a module already named <code>time</code> as part of the Python standard library. You shouldn't create your own variables with the names of things that exist as a part of Python, because it can confuse other developers and lead to bugs in your code. (For example, if we also imported the <code>time</code> module in this program, we might accidentally use the wrong <code>time</code> at different places in the code.) I renamed it to <code>current_time</code>. Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/a4730c5d63e0d73a7dca526e083502a79444c10e#DemonKingdom/demonkingdom_makeover.py">Renamed time to current_time.</a></p>
<p>The source code has several sequential variable names such as <code>level1Text</code>, <code>level2Text</code>, <code>level3Text</code>, and so on. These would be much more manageable in a single list variable. This way we can put the code that uses them into a much more compact loop, rather than a lot of copy/pasted code.</p>
<p>Also, I renamed the <code>sword</code> variable to <code>swordSound</code>, which is more descriptive of what it contains and is consistent with the other sound-related variable names.</p>
<h3>Shorten "== False" and "== True" Code</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/3a9f53a25653904ba7f4d1b19dcc13be1a329583#DemonKingdom/demonkingdom_makeover.py">Shortened the == False and == True expressions.</a></p>
<p>Instead of having expressions that check for equality with <code>True</code> or <code>False</code>, it is more concise to leave this out. I rewrote code like <code>while introdone == False:</code> to the more simple <code>while not introdone:</code>.</p>
<h3>Put Copy/Pasted Code Into Loops</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/a0df431d37c4a9672921446cade4ccbd4f51d969#DemonKingdom/demonkingdom_makeover.py">Put spell casting code in a loop.</a></p>
<p>I rename the <code>spells</code> variable to <code>SPELL_STATS</code> to show that it is a constant. (Oddly again, this variable is in the <code>Sidebar</code> class. I'll move it out in a future change.) </p>
<p>Instead of having a separate <code>if</code> or <code>elif</code> block for each of the three spells, I made a loop that goes through the <code>SPELL_STATS</code> variable and generically handles each spell. This will make it much easier to add spells to the game in the future.</p>
<p>(The <code>numGems = 90</code> change was mistakenly checked in. I had set it to this to test out the game.)</p>
<p>Loops are always preferable to copy/pasting code, because if you have to make a change to it later, you only have to change the code in one place instead of every place it was copy/pasted.</p>
<h3>Get Rid of Unneeded mouseLastDown Variable</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/1370fed11852f9e68ab98bcc90297fdf9154a0f0#DemonKingdom/demonkingdom_makeover.py">let MOUSEBUTTONDOWN event handle clicking code. Got rid of mouseLastDown variable.</a></p>
<p>Instead of checking the <code>pygame.mouse.get_pressed()</code> function to see if the mouse button is currently pressed, we can just examine the MOUSEBUTTONDOWN event that gets generated with each mouse click. This lets us get rid of the extra <code>mouseLastDown</code> variable, and the fewer variables our program has, the easier it is to understand.</p>
<h3>Put Monster Ratios into a MONSTER_RATIOS Variable</h3>
<p>Diff of these changes: <a href="https://github.com/asweigart/source_code_makeover/commit/4c5224f1c3bb98ec6b3cbd3771987eee2fea06ad#DemonKingdom/demonkingdom_makeover.py">Moved the monster proportion data to a new MONSTER_RATIOS variable.</a></p>
<p>Each level has a group of randomly selected monsters from code like <code>type = random.choice(["bat", "bat", "bat", "bat", "plant", "plant", "plant", "orc", "orc", "orc2", "slime"])</code>. The <code>random.choice()</code> function will randomly pick a monster from the list. Instead of having these values hard-coded across the source code, we can put them all into a single <code>MONSTER_RATIOS</code> variable.</p>
<p>That's it for Part 1. In the next part, I'll continue to remove duplicate code and make some readability changes.</p>


</body>
</html>