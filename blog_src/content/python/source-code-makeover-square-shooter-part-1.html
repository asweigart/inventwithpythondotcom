<head>
<title>Source Code Makeover: Square Shooter, Part 1</title>
<meta name="tags" content="" />
<meta name="date" content="2012-08-09 12:00" />
<meta name="summary" content="<p>In this blog post, I'm taking a game off of <a href=&quot;http://pygame.org&quot;>Pygame.org</a> and going through it to make it more readable and extend its functionality. You'll see an example of how to take code that works and changes to improve it's design (but more importantly, I explain why I make those changes).</p>" />
</head>
<body>


			<p>UPDATE: Felix, the original author of Square Shooter, has made some comments in the comment section that are pretty insightful. I recommend you check them out.</p>
<p>In this blog post, I'm taking a game off of <a href="http://pygame.org">Pygame.org</a> and going through it to make it more readable and extend its functionality. You'll see an example of how to take code that works and changes to improve it's design (but more importantly, I explain why I make those changes). This is an intermediate level tutorial and assumes some familiarity with Python. This can be pretty helpful if you know programming basics but want to know, "How can I write better code?"</p>
<p>(<a href="http://inventwithpython.com/blog/2012/08/10/source-code-makeover-square-shooter-part-2/">Part 2</a> and <a href="http://inventwithpython.com/blog/2012/08/13/source-code-makeover-square-shooter-part-3/">Part 3</a> are now up as well.)</p>
<p>This blog post covers <a href="http://www.pygame.org/project-Square+Shooter-2430-4094.html">Square Shooter</a>, made by Felix Ple»ôoianu. You can <a href="http://inventwithpython.com/square-shooter_original.py">download the original source</a> or <a href="https://github.com/asweigart/source_code_makeover/tree/master/square-shooter">view my changes on GitHub</a>.</p>
<p>I only check in working code, so you can <a href="https://github.com/asweigart/source_code_makeover/commits/master/square-shooter">download the code at any point in history and see how it looks</a>. I make a lot more check ins than I normally would, but I want you to see the gradual changes that I make.</p>
<p>(UPDATE: A note to everyone who mentions that I break PEP-8, <a href="http://i.imgur.com/opjIw.jpg">see this link</a>. Also, <a href="http://www.python.org/dev/peps/pep-0008/#a-foolish-consistency-is-the-hobgoblin-of-little-minds">see this link</a>.)</p>
<p><strong>Let's play it.</strong> You'll need to have <a href="http://python.org/getit">Python</a> (a version 2, not version 3) and <a href="http://pygame.org/download.shtml">Pygame</a> installed on your computer to run the <a href="https://github.com/asweigart/source_code_makeover/blob/master/square-shooter/square-shooter_original.py">square-shooter_original.py</a> file. It looks like a standard <a href="http://www.youtube.com/watch?v=cZfsnA7dAHI">Asteroids</a> clone. I notice that the circles dont wrap around the map until the center of the circle goes past the edge. Also, the bullets don't wrap around either, they just stop once they get to the edge.</p>
<p><a href=""/images/squareshooter_screenshot.png""><img src="/images/squareshooter_screenshot.png?27f655" width="300" /></a></p>
<p><strong>Now take a look at <a href="https://github.com/asweigart/source_code_makeover/blob/master/square-shooter/square-shooter_original.py">the original source code</a>.</strong> Try to get an idea of what each of the parts do, but you don't need to fully understand everything before continuing. (I didn't understand all the code when I started cleaning it up.)</p>
<p>First we'll do just a code clean up, and then we'll look at changing the the game to improve play and user experience.</p>
<p>The computer doesn't care what your code looks like. It will run the most unreadable code just fine. <strong>But the purpose of cleaning up code to be readable is so that it is easier to understand for humans so they can easily change code either for new features or bug fixes.</strong> This becomes especially important if multiple people are working on the same source code.</p>
<p><span id="more-909"></span></p>
<p>Also keep in mind that "readable" is a bit subjective. The changes I make here aren't necessarily the changes someone else would make. Feel free to leave your own suggestives in the blog post comments.</p>
<p>First I'll take a rough look through <a href="https://github.com/asweigart/source_code_makeover/blob/master/square-shooter/square-shooter_original.py">the original code</a>. Just a note, all line numbers in this tutorial refer to the original program's line numbers, not the line numbers of my makeover program.</p>
<p>There are very few comments in this script (though I'm bad about this also.) Much of this makeover will be adding comments and documentation.</p>
<p>We'll start at the top of the program and just move down. Each time I make some changes, I constantly retest the program to make sure my changes don't cause any new bugs.</p>
<h3>Spacing and removing duplicating variables</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/0d0a7e901dd72423f06a6c1bb8e7e8738d1572b9#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>When there is nearly identical code, I like to make the spacing match up so it easier to compare them with each other. In this case, you can see that they are all the color variables are tuples of three integers.</p>
<blockquote>
<pre>BLACK  = (  0,   0,   0)

GREEN  = (  0, 204,   0)

RED    = (255,   0,   0)

SILVER = (204, 204, 204)

WHITE  = (255, 255, 255)</pre>
</blockquote>
<p>Note that <code>powerup_types</code> is both a global list defined on line 35 and as a static list in the <code>GameWorld</code> class on line 138. But if you keep grepping for "powerup_types" you'll see it's only used once in the program. Let's get rid of this duplication by deleting lines 35 and 138, and just putting a tuple with the three strings in the one place where it is used.</p>
<p>If we used this list of powerups in more than one place, then putting it in a variable would make sense. But since it's only used in one place, we shouldn't take the extra step of putting it into a variable.</p>
<p>And since this list of three strings is never going to be modified, let's use a tuple instead of a list because tuples are immutable data types.</p>
<p>I'm going to go ahead and commit my changes now with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/0d0a7e901dd72423f06a6c1bb8e7e8738d1572b9#square-shooter">"Aligned the color constants and got rid of the powerup_types variable."</a></p>
<h3>Getting rid of magic numbers</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/e1834e155712e02300297b979769ce010d673f4b#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>scale_and_round()</code> function can be improved. <code>480</code> is a magic number. <strong>Magic numbers are bad.</strong> The number 480 means something to the program, but as a human looking at it the number doesn't tell me anything (and there's no comments to explain them either). Using a small program called <a href="http://www.mioplanet.com/products/pixelruler/">PixelRuler</a> I can confirm that the game map (not the entire window) is 480 x 480 pixels. That's what <code>480</code> in <code>scale_and_round()</code> must refer to. Let's change those <code>480</code> ints to global variables <code>MAP_WIDTH</code> and <code>MAP_HEIGHT</code>.</p>
<blockquote>
<pre>MAP_WIDTH = 480

MAP_HEIGHT = 480



...



self.bglayer.fill(GREEN, (MAP_WIDTH, 0, 160, MAP_HEIGHT))</pre>
</blockquote>
<p>There are some <code>480</code> integer values in the program that don't refer to a width or height so much as a generic size. Since the map is a square, it doesn't matter. But if we ever want to make the map dimensions flexible, we should put this in a variable as well. Let's add a <code>MAP_SIZE</code> global constant as well, and just set it to the larger of the <code>MAP_WIDTH</code> and <code>MAP_HEIGHT</code> constants using <code>max()</code>.</p>
<blockquote>
<pre>MAP_SIZE = max(MAP_WIDTH, MAP_HEIGHT)</pre>
</blockquote>
<p>I also notice on line 522 that the <code>midbottom</code> of some text for the pause screen is placed at the X coordinate <code>240</code> (in the middle of the screen's width). This is another magic number that we can get rid of. Let's replace it with a <code>MAP_HALF_WIDTH</code> constant (and you can see that <code>120</code> and <code>360</code> are also used, so we can add MAP_QUARTER_WIDTH and <code>MAP_THREE_QUARTER_WIDTH</code> constants too, as well as constants for height). We don't use all these values, but for completeness let's just add them anyway in case one day we do change the program to use them.</p>
<p>But what we do need is a <code>WINDOW_WIDTH</code> and <code>WINDOW_HEIGHT</code> for the <code>pygame.display.set_mode()</code> call. Even though <code>WINDOW_HEIGHT</code> and <code>MAP_HEIGHT</code> are both <code>480</code>, they don't describe the same thing. This is why we use two separate constants for them. (Think of it like this: We would want two constants <code>ONE_DOZEN</code> and <code>NUMBER_OF_DUCKLINGS</code> even though they may both contain be <code>12</code>.)</p>
<p>Note that the <code>MAP_SIZE</code>, <code>MAP_QUARTER_WIDTH</code>, <code>MAP_HALF_WIDTH</code>, and <code>MAP_THREE_QUARTER_WIDTH</code> are not directly set with values, but calculated from <code>MAP_WIDTH</code> and <code>MAP_HEIGHT</code>. This way, if we are playing around with these values we only have to update <code>MAP_WIDTH</code> and <code>MAP_HEIGHT</code>, and all the others are automatically updated.</p>
<blockquote>
<pre>model.shoot_at(x / 480.0, y / 480.0)

model.thrust_at(x / 480.0, y / 480.0)</pre>
</blockquote>
<p>One final thing about converting magic numbers to constants. Note that on line 560 and 561, you see the float values <code>480.0</code> instead of the integer values <code>480</code>. This is because in Python 2, dividing two integer values does integer division (e.g. <code>22 / 7</code> is <code>3</code>), which is too imprecise for what we want. This is why Felix used floats, which will force the <code>/</code> operator to do float division (e.g. <code>22 / 7.0</code> is <code>3.142857142857143</code>). One of the improvements of Python 3 was to always make the <code>/</code> do float division.</p>
<p>But if we put <code>MAP_WIDTH</code> and <code>MAP_HEIGHT</code> on these lines, the integer in these constants will cause this to do integer division and cause a weird bug where the ship can only thrust and shoot towards the top left corner of the map. So we wrap them in <code>float()</code> calls to convert them to float values, which ensures that the <code>/</code> operator does float division.</p>
<blockquote>
<pre>model.shoot_at(x / float(MAP_WIDTH), y / float(MAP_HEIGHT))

model.thrust_at(x / float(MAP_WIDTH), y / float(MAP_HEIGHT))</pre>
</blockquote>
<p>Also, there are a few places where the magic number <code>500</code> is used that I will replace with <code>MAP_WIDTH + 20</code>. At this point, we should be able to modify the <code>MAP_WIDTH</code>, <code>MAP_HEIGHT</code>, <code>WINDOW_WIDTH</code>, and <code>WINDOW_HEIGHT</code> variables and the rest of the program scales automatically. (Though the font sizes are based on the window height, so they make look a bit awkward. We can deal with that later.)</p>
<p>I'm going to commit my changes now to git source control with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/e1834e155712e02300297b979769ce010d673f4b#square-shooter">"Replaced the magic numbers for the map and window dimensions with constant variables."</a></p>
<h3>Improve scale_and_round()</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/012f5cf5c93cc72138421aac29887adb28fd0aaa#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>scale_and_round()</code> function can be improved again. First, we'll add a comment saying what it does. Then we can shorten it into a return statement one-liner. (The one liner is just my own preference.)</p>
<blockquote>
<pre>def scale_and_round(x, y):

    """Returns x and y coordinates from 0.0 to 1.0 scaled to 0 to MAP_WIDTH or MAP_HEIGHT."""

    return int(round(x * MAP_WIDTH)), int(round(y * MAP_HEIGHT))</pre>
</blockquote>
<p>Also, at this time I'm going to go ahead and convert all the tabs to 4 spaces with my editor's Find-and-Replace. (<a href="https://github.com/asweigart/source_code_makeover/commit/d2168f9da47fb2d1b820fc92b1fa1cfd0b5b2993#square-shooter">See github.</a>) And then I will make some other magic number replacements also. (<a href="https://github.com/asweigart/source_code_makeover/commit/d06453f30ae135b695b49dca8dbbfba634182118">See github.</a>)</p>
<h3>Add comments to the Bubble2D class</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/7cfc5f837a4c936e3a5414c66c87ef0505e54300#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>Vector2D</code> class looks good, and is straightforward enough that it doesn't <em>need</em> comments. I'll be lazy and skip them.</p>
<p>The <code>Bubble2D</code> class is used for every object in this game: asteroids, the player's ship, bullets, powerups, and explosions. Maybe "bubble" isn't the best name to use. Anyway, this fact should be made more apparent in the comments. The methods also need commenting.</p>
<blockquote>
<pre>class Bubble2D:

    """Represents a circular object on the game map with position, radius, and velocity."""</pre>
</blockquote>
<p>I'll check in these changes with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/7cfc5f837a4c936e3a5414c66c87ef0505e54300#square-shooter">"Added some comments for the Bubble2D class's methods."</a></p>
<h3>Rename position to pos</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/9c7b390e2b3d5d1275ad3e66ddec9264edd3a95b#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>Bubble2D</code> class's <code>position</code> member can be shortened to <code>pos</code>. The word "pos" is generally accepted as a short form of "position" (or, less often, "positive"). You can see in the <code>wrap_around()</code> and <code>is_out()</code> methods that Felix creates a shorter-named <code>pos</code> variable to stand in the place of <code>self.position</code>. Let's cut this middle man out.</p>
<blockquote>
<pre>def __init__(self, radius):

    self.pos = Vector2D(0, 0)</pre>
</blockquote>
<p>Checked in with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/9c7b390e2b3d5d1275ad3e66ddec9264edd3a95b#square-shooter">"Renamed Bubble2D's position member to pos."</a></p>
<h3>Improving Bubble2D.update()</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/e5a7df02e6d7c25230e7fa575a20ebcea418f8bf#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>There's a slight bug with wrap_around() method. Say the horizontal velocity of an object is <code>0.25</code> and the object is already at the <code>0.0</code> X position. In the next one-second update, it will be set to <code>-0.25</code>. If we think of the map as a <del>toroid</del> ring (i.e. going past the left edge moves you to the right edge) this should put the bubble at the <code>0.75</code> X position. But the current <code>wrap_around()</code> method will put it at <code>1</code> (the edge of the map).</p>
<p>The logical bug is that instead of setting the position to <code>0</code> or <code>1</code>, it should actually add or subtract to the current position. I've changed the code to this:</p>
<blockquote>
<pre>def wrap_around(self):

    """Change the position of the bubble to toroidally "wrap around" if it goes off one edge of the map."""

    if self.pos.x < 0: self.pos.x += 1

    if self.pos.y < 0: self.pos.y += 1

    if self.pos.x > 1: self.pos.x -= 1

    if self.pos.y > 1: self.pos.y -= 1</pre>
</blockquote>
<p>Also, it's kind of odd that the <code>Bubble2D</code> object isn't smart enough to call it's own <code>wrap_around()</code> method after the code in <code>update()</code> runs. <strong>This means that the management of Bubble2D objects will have to rely on other code outside the Bubble2D class, which isn't good object-oriented design.</strong> </p>
<p>The reason Felix has the code set up this way is because while he wants every object to wrap except for bullets. But we can fix this. Let's have the <code>update()</code> method call the <code>wrap_around()</code> method, but return <code>True</code> if the object has wrapped around. That way the code that detects when to delete the bullet can know if the bullet's <code>Bubble2D</code> object has wrapped around or not.</p>
<p>Checked in with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/e5a7df02e6d7c25230e7fa575a20ebcea418f8bf#square-shooter">"Updated Bubble2D's update() method. How meta."</a> (Okay, that's a bad habit. You really should keep source control log messages professional and joke-free, especially if you are working on code at your job. It's distracting, and not everyone speaks English as a first language or will get that you are just joking. Also, you might not be as funny as you think you are.)</p>
<h3>Improve Bubble2D.is_out()</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/ffde511d11d1b1ec1d244c02175d88bcfebb2de7#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>is_out()</code> method is a pretty big one liner. If we did something like <code>0 < x < 1 and 0 < y < 1</code>, that would check if the x and y was on the map. And if we put a <code>not</code> operator in front, the logic would be the same as the current <code>is_out()</code>, except a bit more readable.</p>
<p><code>return not (0 < self.pos.x < 1 and 0 < self.pos.y < 1)</code></p>
<p>Checked in with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/ffde511d11d1b1ec1d244c02175d88bcfebb2de7#square-shooter">"Simplified the Bubble2D is_out() method."</a></p>
<h3>Impove Bubble2D.collides_with()</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/4675c45f72e009cc38c6cfb638969187f2cd8729#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>collides_with()</code> method is pretty good, but let's change the name of the bubble parameter to "other", so that we don't confuse it with the current <code>Bubble2D</code> object. Also, since we are squaring the <code>a</code> and <code>b</code> parameters for the Pythagorean Theorem calculation on line 85, there's no reason to get the absolute value of the differences. Even if they are negative, a negative times a negative is positive. So we can get rid of the <code>abs()</code> calls.</p>
<p>Checked in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/4675c45f72e009cc38c6cfb638969187f2cd8729#square-shooter">"Minor changes to the collides_with() method."</a></p>
<h3>random_speed() and random_position() changes</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/991811bfb4edc315cb86b4f904e22cd7a1e4528b#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>random_position()</code> and <code>random_speed()</code> functions desperately need some documentation. I've added a few comments. Better yet, instead of doing all this math on <code>random.random()</code> (which returns a float between <code>0.0</code> and <code>1.0</code>), let's just use Python's <code>random.uniform()</code> to specify those values directly.</p>
<blockquote>
<pre>def random_position():

    """Returns a random float value that will be near the edge of the map"""

    if random.randint(0, 1) == 0:

        return random.uniform(0.0, 0.25)

    else:

        return random.uniform(0.75, 1.0)



def random_speed(magnitude):

    """Returns a random float value between -magnitude and magnitude."""

    return random.uniform(-magnitude, magnitude)</pre>
</blockquote>
<p>Actually, looking at it now, it doesn't make sense that the random position would be from <code>-1.0</code> to <code>2.0</code>, rather than <code>0.0</code> to <code>1.0</code>. This might have been a bug which was masked by the fact that the <code>wrap_around()</code> method will correct any numbers less than <code>0.0</code> or greater than <code>1.0</code>. Then again, <code>wrap_around()</code>'s old behavior (before our changes) would just set it at the boundary. If you look at the starting position of bubbles, you'll notice they did have a propensity for starting at the edges. We can duplicate this behavior with some of our own code, but make it more explicit.</p>
<p>We can also get rid of the superfluous semicolons at the end of these statements. They aren't needed in Python, and just look unpythonic.</p>
<p>Checking in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/991811bfb4edc315cb86b4f904e22cd7a1e4528b#square-shooter">"Simplifying random_speed() and correcting random_position(), also adding documentation."</a></p>
<h3>Rename Bubble2D and simplify</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/38f037186cd286c074fbb46976b4072cdefc1e72#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>The <code>make_bubble()</code> function looks like some kind of factory function (that is, a function that is not an object's constructor function that creates and customizes objects) for the asteroids (which in the source code are called "bubbles".) Since the <code>Bubble2D</code> class is used not only for bubbles but also the ship, bullets, and power ups, this can get kind of confusing. Let's rename the <code>Bubble2D</code> class to something more generic like "ObjectOnMap" ("Object" is a bit too generic for my taste.) This way the <code>make_bubble()</code> function (which we should add documentation to) will be less ambiguous.</p>
<p>Also, since <code>random_speed()</code> is a one-liner and only used in the <code>make_bubble()</code> function, let's just replace the <code>random_speed()</code> calls with <code>random.uniform()</code> calls and get rid of the <code>random_speed()</code> function altogether.</p>
<p>Checked in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/38f037186cd286c074fbb46976b4072cdefc1e72#square-shooter">"Renamed Bubble2D class to ObjectOnMap and got rid of random_speed()."</a></p>
<h3>Improve make_bubble()</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/113c91dd899e1f41ba4a7154b43a24bf00e267c0#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>Now let's improve the code in <code>make_bubble()</code>. Just to make it clear that <code>make_bubble()</code> is a factory function for bubbles, let's rename it to <code>bubble_factory()</code>. The assignment statements for the <code>size</code> and <code>speed</code> variables across line 95 and 103 (remember, these are lines 95 and 103 in the original source file) are not very pythonic. Let's use a dictionary and multiple assignment to simplify them:</p>
<blockquote>
<pre>#                   (size, speed)

kinds  = {'big':    (0.1,   0.1),

          'medium': (0.075, 0.15),

          'small':  (0.05,  0.25)}



size, speed = kinds[kind]</pre>
</blockquote>
<p>This way it'll be more obvious and easy how to add new "kinds" if we ever want, say, <code>"extrabig"</code> bubbles.</p>
<p>Checked in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/113c91dd899e1f41ba4a7154b43a24bf00e267c0#square-shooter">"Improve make_bubble(), and renamed it to bubble_factory()."</a></p>
<h3>Making child classes</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/f30ae547311e944bbb6ed8576ff4782c03f0d9b5#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>Actually, now that I look at it, we should just make a <code>Bubble</code> subclass that is the child class of <code>ObjectOnMap</code>. The code in <code>bubble_factory()</code> can be moved to <code>Bubble</code>'s <code>__init__()</code> function. (All bubbles, after all, are objects on the map.) While we're at it, let's replace <code>random_position()</code> with a single <code>random.random()</code> call (the player has shields at the beginning anyway.)</p>
<p>Note that we should probably fold the <code>spawn_bubbles()</code> method and <code>GameScreen</code>'s <code>bubble_colors</code> member into <code>Bubble2D</code>. This type of info is more relevant to the <code>Bubble</code> objects, not the game world or any screen. We can have <code>spawn_bubbles()</code> be a method (simply named <code>spawn()</code>, since it is already in the <code>Bubble</code> class) that will return a two-item tuple. The first item will be a list of new <code>Bubble</code> objects created and the second will be a list of new Powerup items created.</p>
<p>While making the <code>spawn()</code> method, I noticed that powerups should probably also be a subclass on <code>ObjectOnMap</code>, so I made a <code>Powerup</code> class. The <code>__init__()</code> function for this class can mostly be taken from the <code>spawn_powerup()</code> method.</p>
<p>A minor note, it's kind of odd that <code>spawn_bubbles()</code> uses a variable named <code>new_type</code> instead of keeping consistent naming and calling it <code>new_kind</code>.</p>
<p>Also note, in order to make the <code>super()</code> calls of the <code>Bubble</code> and <code>Powerup</code> child classes to work, we need to change ObjectOnMap to a "new-style" class. This is done by specifying "<code>object</code>" as the class that <code>ObjectOnMap</code> inherits from:</p>
<blockquote>
<pre>class ObjectOnMap(object):</pre>
</blockquote>
<p>Wow, after all those changes, the game actually still works. Checking in these changes with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/f30ae547311e944bbb6ed8576ff4782c03f0d9b5#square-shooter">"#!/usr/bin/python"</a> (because I screwed up when pasting the log message, but it should have been "Created Bubble and Powerup child classes.")</p>
<h3>Adding more comments</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/a6f8972473d7ced51bf709a766852163f5c7142c#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>Now I should add some comments while the code is still fresh in my head (and take out that debugging <code>print</code> statement I accidentally left in in the last check-in.) One thing to notice in my last change is that now that <code>spawn()</code> puts all the new <code>Bubble</code> objects in a list called <code>spawned_bubbles</code> and creates new <code>Bubble</code> objects in a <code>for</code> loop, it's trivial to have <code>Bubbles</code> create any number of new Bubble objects when hit. (Just for fun, try replacing <code>for i in range(2):</code> with <code>for i in range(20):</code>)</p>
<p>Checking in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/a6f8972473d7ced51bf709a766852163f5c7142c#square-shooter">"Added some more comments to Bubble and Powerup classes."</a></p>
<h3>Create a Ship class</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/7170b5af834cb48796badb887208ea83813fe274#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>Next, I notice that a lot of things about the ship (which right now is simply a <code>ObjectOnMap</code> object with some extra attributes added on, or with state tracked by variables in <code>GameState</code> and even <code>GameScreen</code>) that would fit better into a <code>Ship</code> class.</p>
<p>I'll create such a class now. I can move the <code>accel_x</code>, <code>accel_y</code>, and <code>ship_shield_timer</code> variables into this class. I can also move the <code>thrust_at()</code> and <code>stop_thrust()</code> methods into this <code>Ship</code> class.</p>
<blockquote>
<pre>class Ship(ObjectOnMap):

    def __init__(self):

        super(Ship, self).__init__(0.04) # all Ships are the same size.

        self.shield_timer = 0

        self.accel_x = 0 # acceleration rate of the ship

        self.accel_y = 0</pre>
</blockquote>
<p>If we change the <code>ObjectOnMap</code>'s init function to set objects at the XY coordinates of <code>0.5</code>, <code>0.5</code> instead of <code>0</code>, <code>0</code>, then we can save a line of code for the ship. (The <code>Bubble</code> and <code>Powerup</code> init functions set the starting position for those types of objects, and the middle of the screen is a sensible default to have.)</p>
<blockquote>
<pre>def __init__(self, radius):

    self.pos = Vector2D(0.5, 0.5)</pre>
</blockquote>
<p>Also, the magic number <code>0.99</code> can be replaced with a constant named <code>DECELERATION</code>. I also notice that <code>move_timer</code> isn't used for anything and can be removed altogether. </p>
<blockquote>
<pre>DECELERATION = 0.99</pre>
</blockquote>
<p>And finally, I've removed some code that resets the <code>Ship</code> object's position and velocity on a new level, so the <code>Ship</code> continues to move as it did at the end of the last level. I did this accidentally, but kind of like it and will keep it in even though this goes beyond a mere code cleanup and is actually changing the way the game behaves.</p>
<p>Checked in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/7170b5af834cb48796badb887208ea83813fe274#square-shooter">"Created a Ship class and moved code into it."</a></p>
<h3>Get rid of the shield_timer variable and add Ship methods instead</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/335209a898f6bfea494c04427bbfc17f98010e9b#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>Technically, it's bad OOP design to have outside code directly manipulating the <code>Ship</code> object's <code>shield_timer</code> member. Remember that we want to abstract away implementation details for a class. We don't want the logic of how the shield works to exist in code outside the class, because then it could be used inconsistently and there would be more places to change code if we wanted to change the behavior of the shields. Instead of increasing <code>shield_timer</code> by <code>6</code> and checking if <code>shield_timer</code> is greater than <code>0</code>, let's add an <code>add_shield()</code> and <code>has_shield()</code> class.</p>
<blockquote>
<pre>def add_shield(self, secs=6):

    """Extends the time on the ship's shield by secs seconds."""

    self._shield_timer += secs



def has_shield(self):

    """Returns True if this ship currently has a shield, False if it does not have a shield."""

    return self._shield_timer > 0</blockquote></pre>
<p>This way, code that uses the <code>Ship</code> class doesn't need to know how the <code>Ship</code> class implements it's shield (admittedly in this case it's pretty simple since it's just a single integer value) but only needs to know about <code>add_shield()</code> and <code>has_shield()</code> methods.</p>
<p>On line 177 the value of <code>shield_timer</code> is reduced as part of <code>GameWorld</code>'s <code>update()</code> method (the shield reduces over time). We don't need to create a <code>reduce_shield()</code> method for our <code>Ship</code> class, we can just have the logic for reducing the shield a part of the <code>Ship</code>'s <code>update()</code> method. This design ensures that we never accidentally call the <code>Ship</code> object's <code>update()</code> but then forget to reduce the ship's shield.</p>
<p>In the Square Shooter game, the shields are always increased by 6 seconds. Let's add a parameter to the <code>add_shield()</code> method so that you can specify how many seconds to add. (This way we could add a Super Shield powerup that extends the shield by, say, 12 seconds.) But we can make this parameter have a default value of <code>6</code> so that the normal case can just call <code>add_shield()</code> without passing anything.</p>
<p>In Python, there are no private and public members or methods. Everything is public. But to imply that a member or method is private and that a programmer shouldn't directly access or call it, you can add an underscore to the beginning of the name. Let's rename <code>shield_timer</code> to <code>_shield_timer</code>.</p>
<blockquote>
<pre>def __init__(self):

    super(Ship, self).__init__(0.04) # all Ships are the same size.

    self._shield_timer = 0</pre>
</blockquote>
<p>Let's check in these changes with the log message, <a href="https://github.com/asweigart/source_code_makeover/commit/335209a898f6bfea494c04427bbfc17f98010e9b#square-shooter">"Converted shield_timer member to a bunch of methods."</a> after testing to make sure it works.</a></p>
<h3>Create a Bullet class</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/98a3972916f9a464a708db072b9e31357b31ef98#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>And to round everything out, let's add a new class for bullets called <code>Bullet</code>. Currently the bullets are just plain old <code>ObjectOnMap</code> objects with the <code>shoot_at()</code> and custom update behavior implemented outside of <code>ObjectOnMap</code>. Our new class will fix that.</p>
<p>From looking at this code, I realize that <code>bullet_shield_timer</code> is something that should go in the <code>Ship</code> class, not the <code>Bullet</code> class. In Square Shooter, a bullet shield lets a bullet pierce a bubble and continue instead of ceasing to exist once it hits a bubble. This is the timer for how long the <code>Ship</code> can fire bullets that have shields on them, not how long an individual <code>Bullet</code> object has a shield on it. The <code>Bullet</code> class will simply have a boolean shield member to say whether it has a shield or not.</p>
<p>It's kind of confusing for a ship to have "shields" (for the ship) and "bullet shields" (for the bullet), so I'm going to rename the bullet shield to be "Super Bullets".</p>
<blockquote>
<pre>def add_super_bullets(self, secs=6):

    """Extends the time on the ship's super bullets by secs seconds."""

    self._super_bullet_timer += secs



def has_super_bullets(self):

    """Returns True if this ship currently has a super bullets, False if it does not have a super bullets."""

    return self._super_bullet_timer > 0</pre>
</blockquote>
<p>Checking in these changes with the log comment, <a href="https://github.com/asweigart/source_code_makeover/commit/98a3972916f9a464a708db072b9e31357b31ef98#square-shooter">"Created a Bullet class."</a></p>
<h3>Move shoot_at() to the Ship class</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/8b7815451ba312ed0d0c98754cec45358fd422d9#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>Also, I'm going to move the <code>shoot_at()</code> method into the <code>Ship</code> class, since it's the ship that does the shooting. This method will return a list of <code>Bullet</code> objects that are created when <code>shoot_at()</code> is called. (For now the list will just contain one <code>Bullet</code> object, but this lets us be flexible in how many <code>Bullet</code> objects are created.)</p>
<p>Creating the <code>absx</code> and <code>absy</code> variables aren't necessary, because they're only used once. Let's get rid of lines 321 and 322 and just use <code>abs(x)</code> and <code>abs(y)</code> directly in the <code>if</code> statement on line 323.</p>
<blockquote>
<pre>if abs(x) < 0.1 and abs(y) < 0.1:</pre>
</blockquote>
<p>Because <code>shoot_at()</code> is now in the <code>Ship</code> class, we can get rid of these lines (307 and 308):</p>
<blockquote>
<pre>if self.bullet != None or self.ship == None:

    return</pre>
</blockquote>
<p>But keep in mind that this logic also prevents the player from firing a bullet if one exists on the screen, so we'll have to implement that by replacing line 560 with:</p>
<blockquote>
<pre>if model.bullet == None:

    model.bullet = model.ship.shoot_at(x / float(MAP_WIDTH), y / float(MAP_HEIGHT))[0]</pre>
</blockquote>
<p>We can probably find a better place to implement this logic later.</p>
<p>Checking in with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/8b7815451ba312ed0d0c98754cec45358fd422d9#square-shooter">"Moved shoot_at() to the Ship class."</a></p>
<h3>Move the freeze_timer to the Ship class</h3>
<p><a href="https://github.com/asweigart/source_code_makeover/commit/d0e100ce11f20546f352a8abdbd5a50d13e7aa8b#square-shooter">(These changes can be seen in the github history.)</a></p>
<p>At this point the only things that use just <code>ObjectOnMap</code> instead of a class that is derived from <code>ObjectOnMap</code> are the explosions. Let's hold off making a class for them right now, since an "explosion" in Square Shooter is just a circle with a position and radius. <code>ObjectOnMap</code> can handle that just fine.</p>
<p>Let's move the freeze timer logic into the Ship class, just like we did with the shield timer:</p>
<blockquote>
<pre>def add_freeze(self, secs=6):

    """Extends the time on the ship's freeze powerup by secs seconds."""

    self._freeze_timer += secs



def has_freeze(self):

    """Returns True if this ship currently has a freeze powerup, False if it does not have a shield."""

    return self._freeze_timer > 0</blockquote></pre>
<p>Commiting with log message, <a href="https://github.com/asweigart/source_code_makeover/commit/d0e100ce11f20546f352a8abdbd5a50d13e7aa8b#square-shooter">"Moved freeze timer logic into the Ship class, and some other minor changes."</a> (This is lazy of me, I should specify what "other minor changes" is exactly. I'll probably regret this vague log message in the future.)</p>
<h3>End of Part 1</h3>
<p>That's all for now. I'll continue making changes in <a href="http://inventwithpython.com/blog/2012/08/10/source-code-makeover-square-shooter-part-2/">Part 2</a>.</p>


</body>
</html>